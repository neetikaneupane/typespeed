<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Statistics - Typespeed</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        .user-info {
            position: fixed;
            top: 15px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1001;
        }
        .username-display {
            color: #5edfff;
            font-weight: 600;
        }
        .logout-btn, .back-btn {
            background: #ff5c5c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Roboto Mono', monospace;
            transition: 0.3s;
            text-decoration: none;
        }
        .back-btn {
            background: #5edfff;
            color: #0b1e38;
            position: fixed;
            top: 15px;
            left: 20px;
            z-index: 1001;
        }
        .logout-btn:hover {
            background: #ff3d3d;
        }
        .back-btn:hover {
            background: #4ac9e8;
        }
        .stats-container {
            max-width: 1200px;
            margin: 100px auto 20px;
            padding: 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #13294b;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-card h3 {
            color: #5edfff;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        .stat-value {
            font-size: 2.5rem;
            color: #fff;
            font-weight: 700;
        }
        .stat-label {
            font-size: 0.8rem;
            color: #e6eaff;
            opacity: 0.7;
            margin-top: 5px;
        }
        .chart-section {
            background: #13294b;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .chart-section h2 {
            color: #5edfff;
            margin-bottom: 20px;
            text-align: center;
        }
        .chart-container {
            position: relative;
            height: 400px;
        }
        .history-section {
            background: #13294b;
            padding: 30px;
            border-radius: 10px;
        }
        .history-section h2 {
            color: #5edfff;
            margin-bottom: 20px;
            text-align: center;
        }
        .history-table {
            width: 100%;
            border-collapse: collapse;
        }
        .history-table th {
            background: #1b3a63;
            color: #5edfff;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        .history-table td {
            padding: 12px;
            border-bottom: 1px solid #1b3a63;
        }
        .history-table tr:hover {
            background: #1b3a63;
        }
        .difficulty-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .difficulty-easy {
            background: #5edfff;
            color: #0b1e38;
        }
        .difficulty-medium {
            background: #ffb347;
            color: #0b1e38;
        }
        .difficulty-hard {
            background: #ff5c5c;
            color: white;
        }
        .no-data {
            text-align: center;
            padding: 40px;
            color: #e6eaff;
            opacity: 0.7;
        }
        .filter-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-btn {
            background: #1b3a63;
            color: #fff;
            border: 1px solid #355c8c;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.3s;
        }
        .filter-btn:hover, .filter-btn.active {
            background: #5edfff;
            color: #0b1e38;
        }
    </style>
</head>
<body>
<header>
    <div class="keyboard-logo">
        <div class="key-row">
            <div class="key"></div><div class="key"></div><div class="key"></div>
        </div>
        <div class="key-row">
            <div class="key"></div><div class="key"></div><div class="key"></div>
        </div>
        <div class="spacebar"></div>
    </div>
    <h1>Typespeed Statistics</h1>
    <a href="index.html" class="back-btn">‚Üê Back to Test</a>
    <div class="user-info" id="user-info" style="display: none;">
        <span class="username-display" id="username-display"></span>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
</header>

<div class="stats-container">
    <div class="stats-grid" id="stats-summary">
        <div class="stat-card">
            <h3>Tests Taken</h3>
            <div class="stat-value" id="total-tests">0</div>
        </div>
        <div class="stat-card">
            <h3>Best WPM</h3>
            <div class="stat-value" id="best-wpm">0</div>
        </div>
        <div class="stat-card">
            <h3>Average WPM</h3>
            <div class="stat-value" id="avg-wpm">0</div>
        </div>
        <div class="stat-card">
            <h3>Average Accuracy</h3>
            <div class="stat-value" id="avg-accuracy">0%</div>
        </div>
    </div>

    <div class="chart-section">
        <h2>Progress Over Time</h2>
        <div class="filter-section">
            <button class="filter-btn active" onclick="filterChart('all')">All Time</button>
            <button class="filter-btn" onclick="filterChart('7')">Last 7 Days</button>
            <button class="filter-btn" onclick="filterChart('30')">Last 30 Days</button>
        </div>
        <div class="chart-container">
            <canvas id="progressChart"></canvas>
        </div>
    </div>

    <div class="history-section">
        <h2>Test History</h2>
        <table class="history-table" id="history-table">
            <thead>
            <tr>
                <th>Date</th>
                <th>WPM</th>
                <th>Accuracy</th>
                <th>Difficulty</th>
                <th>Duration</th>
            </tr>
            </thead>
            <tbody id="history-body">
            </tbody>
        </table>
    </div>
</div>

<script src="auth.js"></script>
<script>
    let allResults = [];
    let progressChart = null;

    window.addEventListener('DOMContentLoaded', async () => {
        if (isAuthenticated()) {
            const user = getCurrentUser();
            document.getElementById('username-display').textContent = user.username;
            document.getElementById('user-info').style.display = 'flex';
            await loadStatistics();
        } else {
            window.location.href = 'login.html';
        }
    });

    async function loadStatistics() {
        try {
            const results = await getUserResults();
            allResults = results;

            if (results.length === 0) {
                document.getElementById('history-body').innerHTML =
                    '<tr><td colspan="5" class="no-data">No test results yet. Start typing to see your progress!</td></tr>';
                return;
            }

            updateSummaryStats(results);
            renderProgressChart(results);
            renderHistory(results);
        } catch (error) {
            console.error('Failed to load statistics:', error);
        }
    }

    function updateSummaryStats(results) {
        const totalTests = results.length;
        const bestWpm = Math.max(...results.map(r => r.wpm));
        const avgWpm = Math.round(results.reduce((sum, r) => sum + r.wpm, 0) / totalTests);
        const avgAccuracy = (results.reduce((sum, r) => sum + r.accuracy, 0) / totalTests).toFixed(1);

        document.getElementById('total-tests').textContent = totalTests;
        document.getElementById('best-wpm').textContent = bestWpm;
        document.getElementById('avg-wpm').textContent = avgWpm;
        document.getElementById('avg-accuracy').textContent = avgAccuracy + '%';
    }

    function renderProgressChart(results) {
        const ctx = document.getElementById('progressChart').getContext('2d');

        const sortedResults = [...results].sort((a, b) =>
            new Date(a.createdAt) - new Date(b.createdAt)
        );

        const labels = sortedResults.map(r => {
            const date = new Date(r.createdAt);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });

        const wpmData = sortedResults.map(r => r.wpm);
        const accuracyData = sortedResults.map(r => r.accuracy);

        if (progressChart) {
            progressChart.destroy();
        }

        progressChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'WPM',
                        data: wpmData,
                        borderColor: '#5edfff',
                        backgroundColor: 'rgba(94, 223, 255, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Accuracy (%)',
                        data: accuracyData,
                        borderColor: '#ffb347',
                        backgroundColor: 'rgba(255, 179, 71, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        labels: {
                            color: '#e6eaff'
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#e6eaff' },
                        grid: { color: '#1b3a63' }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        ticks: { color: '#5edfff' },
                        grid: { color: '#1b3a63' },
                        title: {
                            display: true,
                            text: 'WPM',
                            color: '#5edfff'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        ticks: { color: '#ffb347' },
                        grid: { display: false },
                        title: {
                            display: true,
                            text: 'Accuracy (%)',
                            color: '#ffb347'
                        }
                    }
                }
            }
        });
    }

    function renderHistory(results) {
        const tbody = document.getElementById('history-body');
        const sortedResults = [...results].sort((a, b) =>
            new Date(b.createdAt) - new Date(a.createdAt)
        );

        tbody.innerHTML = sortedResults.map(result => {
            const date = new Date(result.createdAt);
            const formattedDate = date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            return `
                <tr>
                    <td>${formattedDate}</td>
                    <td><strong>${result.wpm}</strong> WPM</td>
                    <td>${result.accuracy.toFixed(1)}%</td>
                    <td><span class="difficulty-badge difficulty-${result.difficulty}">${result.difficulty.toUpperCase()}</span></td>
                    <td>${result.duration}s</td>
                </tr>
            `;
        }).join('');
    }

    function filterChart(days) {
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        let filteredResults = allResults;

        if (days !== 'all') {
            const daysAgo = new Date();
            daysAgo.setDate(daysAgo.getDate() - parseInt(days));
            filteredResults = allResults.filter(r => new Date(r.createdAt) >= daysAgo);
        }

        if (filteredResults.length > 0) {
            renderProgressChart(filteredResults);
        }
    }
</script>
</body>
</html>